<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ScheduleBSUIR.View.TimetablePage"
             x:DataType="vm:TimetablePageViewModel"
             xmlns:vm="clr-namespace:ScheduleBSUIR.Viewmodels"
             xmlns:model="clr-namespace:ScheduleBSUIR.Models"
             xmlns:view="clr-namespace:ScheduleBSUIR.View"
             xmlns:converters="clr-namespace:ScheduleBSUIR.Helpers.Converters"
             xmlns:convertersCommon="clr-namespace:ScheduleBSUIR.Helpers.Converters.Common"
             xmlns:constants="clr-namespace:ScheduleBSUIR.Helpers.Constants"
             xmlns:controls="clr-namespace:ScheduleBSUIR.View.Controls"
             xmlns:dx="http://schemas.devexpress.com/maui"
             xmlns:mtk="clr-namespace:MemoryToolkit.Maui;assembly=MemoryToolkit.Maui"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             mtk:LeakMonitorBehavior.Cascade="True"
             mtk:TearDownBehavior.Cascade="True"
             Shell.NavBarIsVisible="False"
             Background="Black">

    <ContentPage.Resources>
        <ResourceDictionary>
            <convertersCommon:ValueToBoolConverter
                x:Key="ScheduleTabSelected"
                TrueValue="{x:Static constants:TimetableTabs.Schedule}"/>
            <convertersCommon:ValueToBoolConverter
                x:Key="ExamsTabSelected"
                TrueValue="{x:Static constants:TimetableTabs.Exams}"/>
            <convertersCommon:BoolToValueConverter
                x:Key="BookmarkSelected"
                TrueValue="dark_bookmark_active"
                FalseValue="dark_bookmark_inactive"/>
            <converters:DateToHeaderTextConverter
                x:Key="DateToHeaderTextConverter"/>
            <converters:TimetableToHeaderTextConverter
                x:Key="TimetableToHeaderTextConverter"/>
            <converters:SubgroupTypeToStringConverter
                x:Key="SubgroupTypeToStringConverter"/>
            <toolkit:EnumToIntConverter 
                x:Key="EnumToIntConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <!-- Navbar -->
        <Grid
            x:Name="navBar"
            ZIndex="1"
            Padding="15"
            VerticalOptions="Start"
            ColumnSpacing="10"
            ColumnDefinitions="auto,*,auto,auto">

            <Grid.Background>
                <LinearGradientBrush
                    StartPoint="0,0"
                    EndPoint="0,1">
                    <GradientStop
                        Color="#AA000000"
                        Offset="0.0" />
                    <GradientStop 
                        Color="Transparent"
                        Offset="1.0" />
                </LinearGradientBrush>
            </Grid.Background>

            <Grid
                Grid.Column="0"
                Padding="0,10,20,10"
                WidthRequest="40"
                HeightRequest="40">
                <Image
                    Source="dark_arrow_left"/>
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer
                        Command="{Binding NavigateBackCommand}"/>
                </Grid.GestureRecognizers>
            </Grid>

            <controls:CustomTabbar
                HorizontalOptions="Center"
                Grid.Column="1"
                Tab="{Binding SelectedTab, Mode=TwoWay}">
            </controls:CustomTabbar>

            <!--Timetable mode toggle-->
            <Grid
                Grid.Column="2"
                Padding="10"
                WidthRequest="40"
                HeightRequest="40">
                <Grid
                    ColumnDefinitions="auto,auto">
                    <Label
                        Grid.Column="0"
                        IsVisible="True"
                        Style="{StaticResource LabelBodyPrimaryStyle}"
                        Text="{Binding SelectedMode, Converter={StaticResource EnumToIntConverter}}">
                        <Label.Triggers>
                            <DataTrigger
                                TargetType="Label"
                                Binding="{Binding SelectedMode, Converter={convertersCommon:ValueToBoolConverter TrueValue={x:Static constants:SubgroupType.All}}}"
                                Value="True">
                                <Setter
                                    Property="IsVisible"
                                    Value="False"/>
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    <Image
                        Grid.Column="1"
                        Source="dark_user">
                        <Image.Triggers>
                            <DataTrigger
                                TargetType="Image"
                                Binding="{Binding SelectedMode, Converter={convertersCommon:ValueToBoolConverter TrueValue={x:Static constants:SubgroupType.All}}}"
                                Value="True">
                                <Setter
                                    Property="Source"
                                    Value="dark_users"/>
                            </DataTrigger>
                        </Image.Triggers>
                    </Image>
                </Grid>
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer
                        Command="{Binding ToggleTimetableModePopupCommand}"/>
                </Grid.GestureRecognizers>
            </Grid>

            <!--boormark toggle-->
            <Grid
                IsEnabled="{Binding Timetable, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                Grid.Column="3"
                Padding="10"
                WidthRequest="40"
                HeightRequest="40">
                <Image
                    Source="{Binding Favorited, Converter={StaticResource BookmarkSelected}}"/>
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer
                        Command="{Binding ToogleBookmarkCommand}"/>
                </Grid.GestureRecognizers>
            </Grid>
            
            <!--Timetable mode popup-->
            <dx:DXPopup
                PlacementTarget="{x:Reference navBar}"
                IsOpen="{Binding IsTimetableModePopupOpen}">
                <dx:DXPopup.Resources>
                    <ResourceDictionary>
                        <Style TargetType="Grid">
                            <Setter Property="ColumnDefinitions" Value="auto,*,auto"/>
                            <Setter Property="ColumnSpacing" Value="15"/>
                            <Setter Property="HeightRequest" Value="36"/>
                        </Style>
                    </ResourceDictionary>
                </dx:DXPopup.Resources>

                <Border
                    Padding="20,10"
                    BackgroundColor="{StaticResource DarkControlBackground}">
                    <VerticalStackLayout
                        Spacing="10">
                        <VerticalStackLayout.Resources>
                            <ResourceDictionary>
                                <Style TargetType="Image">
                                    <Setter Property="WidthRequest" Value="20"/>
                                    <Setter Property="Opacity" Value="0.5"/>
                                </Style>

                                <Style TargetType="Label">
                                    <Setter Property="Style" Value="{StaticResource LabelBodyPrimaryStyle}"/>
                                    <Setter Property="VerticalOptions" Value="Center"/>
                                </Style>
                            </ResourceDictionary>
                        </VerticalStackLayout.Resources>

                        <Grid>
                            <Image
                                Grid.Column="0"
                                Source="dark_user"/>
                            <Label
                                Grid.Column="1"
                                Text="{Binding Source={x:Static constants:SubgroupType.FirstSubgroup}, Converter={StaticResource SubgroupTypeToStringConverter}}"/>
                            <Image
                                Grid.Column="2"
                                Source="dark_check"
                                IsVisible="{Binding SelectedMode, Converter={convertersCommon:ValueToBoolConverter TrueValue={x:Static constants:SubgroupType.FirstSubgroup}}}"/>
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding ToggleModeCommand}"
                                    CommandParameter="{x:Static constants:SubgroupType.FirstSubgroup}"/>
                            </Grid.GestureRecognizers>
                        </Grid>

                        <Grid>
                            <Image
                                Grid.Column="0"
                                Source="dark_user"/>
                            <Label
                                Grid.Column="1"
                                Text="{Binding Source={x:Static constants:SubgroupType.SecondSubgroup}, Converter={StaticResource SubgroupTypeToStringConverter}}"/>
                            <Image
                                Grid.Column="2"
                                Source="dark_check"
                                IsVisible="{Binding SelectedMode, Converter={convertersCommon:ValueToBoolConverter TrueValue={x:Static constants:SubgroupType.SecondSubgroup}}}"/>
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding ToggleModeCommand}"
                                    CommandParameter="{x:Static constants:SubgroupType.SecondSubgroup}"/>
                            </Grid.GestureRecognizers>
                        </Grid>

                        <Grid>
                            <Image
                                Grid.Column="0"
                                Source="dark_users"/>
                            <Label
                                Grid.Column="1"
                                Text="{Binding Source={x:Static constants:SubgroupType.All}, Converter={StaticResource SubgroupTypeToStringConverter}}"/>
                            <Image
                                Grid.Column="2"
                                Source="dark_check"
                                IsVisible="{Binding SelectedMode, Converter={convertersCommon:ValueToBoolConverter TrueValue={x:Static constants:SubgroupType.All}}}"/>
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding ToggleModeCommand}"
                                    CommandParameter="{x:Static constants:SubgroupType.All}"/>
                            </Grid.GestureRecognizers>
                        </Grid>

                    </VerticalStackLayout>
                </Border>
            </dx:DXPopup>
        </Grid>

        <!-- Skeleton of timetable -->
        <dx:DXCollectionView
            ItemSpacing="5"
            IsVisible="{Binding IsSkeletonVisible}"
            IsPullToRefreshEnabled="True"
            IsRefreshing="{Binding IsRefreshing}"
            PullToRefreshCommand="{Binding RefreshCommand}"
            Margin="15,0">
            <dx:DXCollectionView.ItemsSource>
                <x:Array Type="{x:Type x:Int16}">
                    <x:Int16>0</x:Int16>
                    <x:Int16>0</x:Int16>
                    <x:Int16>1</x:Int16>
                    <x:Int16>1</x:Int16>
                    <x:Int16>1</x:Int16>
                    <x:Int16>2</x:Int16>
                    <x:Int16>2</x:Int16>
                </x:Array>
            </dx:DXCollectionView.ItemsSource>

            <dx:DXCollectionView.Header>
                <Grid
                    Margin="0,100,0,20"
                    RowDefinitions="auto,auto"
                    RowSpacing="10">
                    <Label
                        Grid.Column="0"
                        VerticalOptions="Center"
                        Style="{StaticResource LabelHeaderStyle}"
                        Text="{Binding TimetableHeader}"/>
                    <Border
                        Grid.Row="1"
                        WidthRequest="240"
                        HorizontalOptions="Start"
                        HeightRequest="18"
                        BackgroundColor="{StaticResource DarkLightControlBackground}"/>
                </Grid>
            </dx:DXCollectionView.Header>

            <!--<dx:DXCollectionView.GroupHeaderTemplate>
                <DataTemplate>
                    <Border
                        Grid.Row="0"
                        Margin="0,20,0,0"
                        WidthRequest="240"
                        HorizontalOptions="Start"
                        BackgroundColor="{StaticResource DarkControlBackground}"
                        HeightRequest="20"/>
                </DataTemplate>
            </dx:DXCollectionView.GroupHeaderTemplate>-->

            <dx:DXCollectionView.ItemTemplate>
                <StaticResource Key="SkeletonLessonTemplate"/>
            </dx:DXCollectionView.ItemTemplate>
        </dx:DXCollectionView>

         <!-- Timetable collectionview -->
        <dx:DXCollectionView
            x:Name="dayScheduleCollectionView"
            AllowCascadeUpdate="False"
            ReduceSizeToContent="True"
            Grid.Row="1"
            Margin="15,0"
            ItemsSource="{Binding Schedule}"
            ItemSpacing="5"
            IsLoadMoreEnabled="True"
            IsRefreshing="{Binding IsLoadingMoreSchedule}"
            LoadMoreCommand="{Binding LoadMoreScheduleCommand}">

            <!--todo bind tab-->
            <dx:DXCollectionView.Header>
                <controls:TimetableHeader
                    Margin="0,100,0,20"
                    Tab="{x:Static constants:TimetableTabs.Exams}"
                    Timetable="{Binding Timetable}"/>
            </dx:DXCollectionView.Header>

            <dx:DXCollectionView.ItemTemplate>
                <DataTemplate
                    x:DataType="model:DaySchedule">
                    <Border>
                        <Grid
                            RowDefinitions="auto,auto">
                            <!--active-->
                            <Label
                                Grid.Row="0"
                                Margin="0,20,0,10"
                                Style="{StaticResource LabelBodyHeaderStyle}"
                                Text="{Binding Day, Converter={StaticResource DateToHeaderTextConverter}}"/>
                            <!--inactive-->
                            <!--<Label
                                Margin="0,10,0,5"
                                Opacity="0.35"
                                Style="{StaticResource LabelHeaderStyle}"
                                FontSize="15"
                                Text="{Binding Day, Converter={StaticResource DateToHeaderTextConverter}}"/>-->
                            <dx:DXCollectionView
                                Grid.Row="1"
                                AllowCascadeUpdate="True"
                                IsScrollBarVisible="False"
                                ReduceSizeToContent="True"
                                ItemsSource="{Binding .}"
                                ItemTemplate="{StaticResource LessonTemplateSelector}"
                                SelectionMode="Single"
                                SelectionChanged="scheduleCollectionView_SelectionChanged"
                                ItemSpacing="5"/>
                        </Grid>
                    </Border>
                </DataTemplate>
            </dx:DXCollectionView.ItemTemplate>

            <dx:DXCollectionView.Triggers>
                <DataTrigger
                    TargetType="dx:DXCollectionView"
                    Binding="{Binding IsBusy}"
                    Value="True">
                    <Setter
                        Property="IsVisible"
                        Value="False"/>
                </DataTrigger>
            </dx:DXCollectionView.Triggers>
        </dx:DXCollectionView>

        <!--todo: No empty view on dxcv?-->
        <AbsoluteLayout
            IsVisible="False">
            <!--IsVisible="{Binding Schedule, Converter={StaticResource IsEmptyConverter}}">-->
            <Grid
                VerticalOptions="Center"
                AbsoluteLayout.LayoutBounds="0.5, 0.5, 250, 200"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                Opacity="0.5"
                RowSpacing="20"
                RowDefinitions="auto,auto">
                <Image
                    WidthRequest="100"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    Grid.Row="0"
                    Source="party"/>
                <Label
                    Grid.Row="1"
                    HorizontalTextAlignment="Center"
                    Style="{StaticResource LabelBodyHeaderStyle}"
                    Text="Занятий больше нет"/>
            </Grid>

            <AbsoluteLayout.Triggers>
                <DataTrigger
                    TargetType="AbsoluteLayout"
                    Binding="{Binding IsBusy}"
                    Value="True">
                    <Setter
                        Property="IsVisible"
                        Value="False"/>
                </DataTrigger>
            </AbsoluteLayout.Triggers>
        </AbsoluteLayout>

        <!-- Bottom sheet with schedule details -->
        <dx:BottomSheet 
            x:Name="examDetailSheet" 
            ShowGrabber="True" 
            AllowDismiss="True" 
            StateChanged="examDetailSheet_StateChanged"
            CornerRadius="12"
            Padding="15,30"
            HalfExpandedRatio="0.5"
            BackgroundColor="{StaticResource DarkControlBackground}"
            IsModal="true"
            x:DataType="model:Schedule">

            <VerticalStackLayout
                x:Name="sheetContent"
                Spacing="20">
                <VerticalStackLayout.Resources>
                    <ResourceDictionary>
                        <Style
                            TargetType="Grid">
                            <Setter
                                Property="ColumnDefinitions"
                                Value="auto, *"/>
                            <Setter
                                Property="ColumnSpacing"
                                Value="10"/>
                        </Style>

                        <converters:SubgroupTypeToStringConverter
                        x:Key="SubgroupTypeToStringConverter"/>
                    </ResourceDictionary>
                </VerticalStackLayout.Resources>

                <Label
                    Margin="0,0,0,-5"
                    LineBreakMode="WordWrap"
                    Style="{StaticResource LabelBodyHeaderStyle}"
                    Text="{Binding SubjectFullName}"/>

                <!--Schedule details-->
                <Border
                    Padding="15"
                    BackgroundColor="{StaticResource DarkLightControlBackground}">

                    <VerticalStackLayout
                        Spacing="20">
                        <!--type-->
                        <Grid>
                            <Label
                                Grid.Column="0"
                                Style="{StaticResource LabelBodyPrimaryStyle}"
                                Text="Тип"/>
                            <Label
                                Grid.Column="1"
                                HorizontalTextAlignment="End"
                                Style="{StaticResource LabelBodySecondaryStyle}"
                                Text="{Binding LessonTypeAbbrev}"/>
                        </Grid>

                        <!--subgroup-->
                        <Grid>
                            <Label
                                Grid.Column="0"
                                Style="{StaticResource LabelBodyPrimaryStyle}"
                                Text="Подгруппа"/>
                            <Label
                                Grid.Column="1"
                                HorizontalTextAlignment="End"
                                Style="{StaticResource LabelBodySecondaryStyle}"
                                Text="{Binding NumSubgroup, Converter={StaticResource SubgroupTypeToStringConverter}}"/>
                        </Grid>

                        <!--date-->
                        <Grid>
                            <Label
                                Grid.Column="0"
                                Style="{StaticResource LabelBodyPrimaryStyle}"
                                Text="Дата"/>
                            <Label
                                Grid.Column="1"
                                HorizontalTextAlignment="End"
                                Style="{StaticResource LabelBodySecondaryStyle}"
                                Text="{Binding DateLesson, StringFormat='{}{0:dd MMMM yyyy г.}'}"/>
                        </Grid>

                        <!--time-->
                        <Grid>
                            <Label
                                Grid.Column="0"
                                Style="{StaticResource LabelBodyPrimaryStyle}"
                                Text="Время"/>
                            <Label
                                Grid.Column="1"
                                HorizontalTextAlignment="End"
                                Style="{StaticResource LabelBodySecondaryStyle}">
                                <Label.Text>
                                    <MultiBinding
                                        StringFormat="{}{0} - {1}">
                                        <Binding
                                            Path="StartLessonTime"
                                            StringFormat="{}{0:HH:mm}"/>
                                        <Binding
                                            Path="EndLessonTime"
                                            StringFormat="{}{0:HH:mm}"/>
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                        </Grid>

                        <!--auditories-->
                        <Grid>
                            <Label
                                Grid.Column="0"
                                Style="{StaticResource LabelBodyPrimaryStyle}"
                                Text="Аудитория"/>
                            <Label
                                Grid.Column="1"
                                HorizontalTextAlignment="End"
                                Style="{StaticResource LabelBodySecondaryStyle}"
                                Text="{Binding Auditories, Converter={converters:StringListToStringConverter}}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <Label
                    IsVisible="{Binding Note, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                    Text="Примечания"
                    Margin="15,0,0,-10"
                    Style="{StaticResource LabelBodySecondaryStyle}"/>

                <!--Remarks (if present)-->
                <Border
                    IsVisible="{Binding Note, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                    Padding="15"
                    BackgroundColor="{StaticResource DarkLightControlBackground}">
                    <Label
                        Text="{Binding Note}"
                        Style="{StaticResource LabelBodyPrimaryStyle}"/>
                </Border>

                <Label
                    IsVisible="{Binding Employees, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                    Text="Преподаватели"
                    Margin="15,0,0,-10"
                    Style="{StaticResource LabelBodySecondaryStyle}"/>

                <!--Schedule lecturers-->
                <VerticalStackLayout
                    Spacing="10"
                    BindableLayout.ItemsSource="{Binding Employees}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate
                            x:DataType="model:EmployeeDto">
                            <Border
                                HeightRequest="70"
                                BackgroundColor="{StaticResource DarkLightControlBackground}">
                                <Grid
                                    ColumnSpacing="15"
                                    Padding="15,10"
                                    ColumnDefinitions="auto,*,auto">

                                    <Image
                                        VerticalOptions="Center"
                                        Grid.Column="0"
                                        HeightRequest="50"
                                        Aspect="AspectFill">
                                        <Image.Source>
                                            <UriImageSource
                                                Uri="{Binding PhotoLink}"
                                                CachingEnabled="True"
                                                CacheValidity="10:00:00:00"/>
                                        </Image.Source>

                                        <Image.Clip>
                                            <EllipseGeometry
                                                Center="25,25"
                                                RadiusX="25"
                                                RadiusY="25"/>
                                        </Image.Clip>
                                    </Image>

                                    <!--todo: converter?-->
                                    <Label
                                        Grid.Column="1"
                                        VerticalOptions="Center"
                                        MaxLines="2"
                                        LineHeight="1.1"
                                        LineBreakMode="WordWrap"
                                        Style="{StaticResource LabelBodyPrimaryStyle}">
                                        <Label.Text>
                                            <MultiBinding
                                                StringFormat="{}{2} {0} {1}">
                                                <Binding Path="FirstName"/>
                                                <Binding Path="MiddleName"/>
                                                <Binding Path="LastName"/>
                                            </MultiBinding>
                                        </Label.Text>
                                    </Label>

                                    <Image
                                        Grid.Column="2"
                                        HeightRequest="16"
                                        Opacity="0.5"
                                        Source="dark_arrow_right"/>
                                </Grid>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Tapped="employee_tapped"
                                        Command="{Binding Source={x:RelativeSource AncestorType={x:Type vm:TimetablePageViewModel}}, Path=NavigateToTimetableCommand}"
                                        CommandParameter="{Binding .}"/>
                                </Border.GestureRecognizers>
                            </Border>

                        </DataTemplate>
                    </BindableLayout.ItemTemplate>

                </VerticalStackLayout>
            </VerticalStackLayout>
        </dx:BottomSheet>
    </Grid>
</ContentPage>